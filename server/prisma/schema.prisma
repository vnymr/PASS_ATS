generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int               @id @default(autoincrement())
  email            String            @unique
  password         String
  createdAt        DateTime          @default(now())
  clerkId          String?           @unique
  autoApplications AutoApplication[]
  conversations    Conversation[]
  gmailConnection  GmailConnection?
  goals            Goal[]
  jobs             Job[]
  payments         Payment[]
  profile          Profile?
  resumeTemplates  ResumeTemplate[]
  routines         Routine[]
  subscription     Subscription?
  usageTracking    UsageTracking[]
}

model GmailConnection {
  id           String    @id @default(cuid())
  userId       Int       @unique
  email        String
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  scope        String
  isActive     Boolean   @default(true)
  lastUsed     DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model Profile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  data      Json
  updatedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model ResumeTemplate {
  id        String   @id @default(cuid())
  userId    Int
  name      String
  latex     String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
}

model Job {
  id             String      @id @default(cuid())
  userId         Int?
  status         JobStatus   @default(PENDING)
  priority       Int         @default(0)
  attempts       Int         @default(0)
  maxAttempts    Int         @default(3)
  resumeText     String?     @default("")
  jobDescription String
  aiMode         String?
  matchMode      String?
  error          String?
  diagnostics    Json?
  processingLog  Json[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  startedAt      DateTime?
  completedAt    DateTime?
  company        String?
  jobUrl         String?
  role           String?
  metadata       Json?
  artifacts      Artifact[]
  embeddings     Embedding[]
  user           User?       @relation(fields: [userId], references: [id])

  @@index([status, priority, createdAt])
  @@index([userId])
}

model Artifact {
  id        String       @id @default(cuid())
  jobId     String
  type      ArtifactType
  version   Int          @default(1)
  content   Bytes
  metadata  Json?
  schema    Json?
  validated Boolean      @default(false)
  createdAt DateTime     @default(now())
  job       Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, type, version])
  @@index([jobId, type])
}

model Embedding {
  id          String        @id @default(cuid())
  jobId       String
  content     String
  contentType EmbeddingType
  embedding   Float[]
  relevance   Float?
  createdAt   DateTime      @default(now())
  job         Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, contentType])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               Int                @unique
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  tier                 SubscriptionTier   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model UsageTracking {
  id               String           @id @default(cuid())
  userId           Int
  date             DateTime         @default(now())
  resumesGenerated Int              @default(0)
  dailyLimit       Int
  tier             SubscriptionTier
  resetAt          DateTime
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model Payment {
  id              String        @id @default(cuid())
  userId          Int
  stripePaymentId String        @unique
  amount          Int
  currency        String        @default("usd")
  status          PaymentStatus
  description     String?
  createdAt       DateTime      @default(now())
  user            User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([stripePaymentId])
}

model AggregatedJob {
  id                   String            @id @default(cuid())
  externalId           String            @unique
  source               String
  title                String
  company              String
  location             String?
  salary               String?
  description          String
  requirements         String?
  applyUrl             String
  companyUrl           String?
  atsType              String
  atsCompany           String?
  atsComplexity        String
  atsConfidence        Float
  aiApplyable          Boolean           @default(false)
  postedDate           DateTime
  expiresAt            DateTime?
  lastChecked          DateTime          @default(now())
  isActive             Boolean           @default(true)
  extractedSkills      String[]          @default([])
  extractedExperience  String?
  extractedEducation   String?
  extractedJobLevel    String?
  extractedKeywords    String[]          @default([])
  extractedBenefits    String[]          @default([])
  lastExtractedAt      DateTime?
  extractionConfidence Float?
  closedAt             DateTime?
  createdAt            DateTime          @default(now())
  firstSeenAt          DateTime          @default(now())
  updatedAt            DateTime?         @updatedAt
  applications         AutoApplication[]

  @@index([aiApplyable, postedDate])
  @@index([isActive, postedDate])
  @@index([isActive, aiApplyable, postedDate])
  @@index([isActive, source, postedDate])
  @@index([lastChecked])
  @@index([atsType])
  @@index([source])
  @@index([company])
  @@index([location])
  @@index([postedDate])
  @@index([extractedSkills], type: Gin)
}

model AutoApplication {
  id               String                @id @default(cuid())
  userId           Int
  jobId            String
  method           String                @default("AI_AUTO")
  submittedAt      DateTime?
  confirmationUrl  String?
  confirmationId   String?
  confirmationData Json?
  error            String?
  errorType        String?
  retryCount       Int                   @default(0)
  maxRetries       Int                   @default(3)
  cost             Float                 @default(0.0)
  createdAt        DateTime              @default(now())
  startedAt        DateTime?
  completedAt      DateTime?
  status           AutoApplicationStatus @default(QUEUED)
  job              AggregatedJob         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  workerSession    WorkerSession?

  @@unique([userId, jobId])
  @@index([userId, status])
  @@index([status])
  @@index([createdAt])
}

model ApplicationRecipe {
  id            String            @id @default(cuid())
  platform      String            @unique
  atsType       String
  version       Int               @default(1)
  steps         Json
  successRate   Float             @default(1.0)
  timesUsed     Int               @default(0)
  failureCount  Int               @default(0)
  recordingCost Float             @default(0.80)
  replayCost    Float             @default(0.05)
  totalSaved    Float             @default(0.0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  lastUsed      DateTime?
  lastFailure   DateTime?
  recordedBy    String?
  executions    RecipeExecution[]

  @@index([platform])
  @@index([atsType])
  @@index([successRate])
}

model RecipeExecution {
  id         String            @id @default(cuid())
  recipeId   String
  success    Boolean
  method     String
  duration   Int?
  cost       Float
  error      String?
  errorType  String?
  jobUrl     String?
  executedAt DateTime          @default(now())
  recipe     ApplicationRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId, executedAt])
  @@index([success])
}

model DiscoveredCompany {
  id             String   @id @default(cuid())
  atsType        String
  slug           String
  name           String?
  discoveredAt   DateTime @default(now())
  discoveredFrom String?
  lastFetchedAt  DateTime
  isActive       Boolean  @default(true)
  totalJobs      Int      @default(0)
  lastJobCount   Int      @default(0)

  @@unique([atsType, slug])
  @@index([atsType, isActive])
  @@index([lastFetchedAt])
}

model Conversation {
  id            String    @id @default(cuid())
  userId        Int?
  title         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime  @default(now())
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goals         Goal[]
  messages      Message[]

  @@index([userId, lastMessageAt])
  @@index([createdAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           MessageRole
  content        String
  metadata       Json?
  tokenCount     Int?
  cost           Float?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model Goal {
  id             String        @id @default(cuid())
  conversationId String?
  userId         Int
  title          String
  description    String?
  type           GoalType      @default(JOB_SEARCH)
  status         GoalStatus    @default(ACTIVE)
  targetDate     DateTime?
  completedAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  metadata       Json?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([conversationId])
}

model MessageUsage {
  id        String   @id @default(cuid())
  userId    Int?
  ip        String?
  date      DateTime @default(now())
  count     Int      @default(1)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@unique([ip, date])
  @@index([userId, date])
  @@index([ip, date])
  @@index([resetAt])
}

model Routine {
  id          String             @id @default(cuid())
  userId      Int
  title       String
  description String?
  type        RoutineType        @default(SEARCH_JOBS)
  frequency   String             @default("DAILY")
  schedule    String             @default("09:00")
  config      Json?
  isActive    Boolean            @default(true)
  lastRun     DateTime?
  nextRun     DateTime?
  runCount    Int                @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions  RoutineExecution[]

  @@index([userId, isActive])
  @@index([nextRun, isActive])
  @@index([type, isActive])
}

model RoutineExecution {
  id        String   @id @default(cuid())
  routineId String
  status    String   @default("SUCCESS")
  summary   String?
  results   Json?
  duration  Int?
  error     String?
  createdAt DateTime @default(now())
  routine   Routine  @relation(fields: [routineId], references: [id], onDelete: Cascade)

  @@index([routineId, createdAt])
  @@index([status])
}

model Worker {
  id               Int             @id @default(autoincrement())
  email            String          @unique
  password         String
  name             String
  isActive         Boolean         @default(true)
  role             WorkerRole      @default(OPERATOR)
  totalCompleted   Int             @default(0)
  totalFailed      Int             @default(0)
  totalSkipped     Int             @default(0)
  avgTimeSeconds   Int?
  lastActiveAt     DateTime?
  currentSessionId String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  sessions         WorkerSession[]

  @@index([isActive])
  @@index([email])
}

model WorkerSession {
  id                String              @id @default(cuid())
  workerId          Int?
  autoApplicationId String              @unique
  status            WorkerSessionStatus @default(QUEUED)
  browserSessionId  String?
  vncUrl            String?
  queuedAt          DateTime            @default(now())
  assignedAt        DateTime?
  aiStartedAt       DateTime?
  aiCompletedAt     DateTime?
  submittedAt       DateTime?
  completedAt       DateTime?
  formData          Json?
  screenshotUrl     String?
  workerNotes       String?
  failReason        String?
  skipReason        String?
  autoApplication   AutoApplication     @relation(fields: [autoApplicationId], references: [id], onDelete: Cascade)
  worker            Worker?             @relation(fields: [workerId], references: [id])

  @@index([status])
  @@index([workerId, status])
  @@index([queuedAt])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

enum ArtifactType {
  RESUME_JSON
  LATEX_SOURCE
  PDF_OUTPUT
  JOB_DESCRIPTION
  DIAGNOSTIC_LOG
}

enum EmbeddingType {
  SKILL
  EXPERIENCE
  REQUIREMENT
  KEYWORD
}

enum SubscriptionTier {
  FREE
  PRO
  UNLIMITED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  PAUSED
  INCOMPLETE
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum AutoApplicationStatus {
  QUEUED
  APPLYING
  SUBMITTED
  FAILED
  CANCELLED
  RETRYING
  MANUAL_REQUIRED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum GoalType {
  JOB_SEARCH
  RESUME_IMPROVEMENT
  SKILL_DEVELOPMENT
  INTERVIEW_PREP
  CAREER_PLANNING
  OTHER
}

enum GoalStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum RoutineType {
  SEARCH_JOBS
  APPLY_TO_JOBS
  REVIEW_APPLICATIONS
  UPDATE_GOALS
  DAILY_DIGEST
  WEEKLY_SUMMARY
  CUSTOM
}

enum WorkerRole {
  OPERATOR
  ADMIN
}

enum WorkerSessionStatus {
  QUEUED
  ASSIGNED
  AI_PROCESSING
  READY_FOR_SUBMIT
  SUBMITTED
  COMPLETED
  FAILED
  SKIPPED
}
